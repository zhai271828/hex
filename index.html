<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { 
  getDatabase, ref, set, onValue, push,
  update, runTransaction, onDisconnect, remove, get
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "ä½ çš„key",
  authDomain: "ä½ çš„authDomain",
  databaseURL: "ä½ çš„dbURL",
  projectId: "ä½ çš„projectId",
  storageBucket: "ä½ çš„bucket",
  messagingSenderId: "ä½ çš„senderId",
  appId: "ä½ çš„appId"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* æˆ¿é—´ */
let roomId = localStorage.getItem("roomId") || prompt("è¯·è¾“å…¥æˆ¿é—´å·") || "1";
localStorage.setItem("roomId", roomId);

const roomRef = ref(db, `rooms/${roomId}`);
const poolRef = ref(db, `rooms/${roomId}/pool`);
const playersRef = ref(db, `rooms/${roomId}/players`);
const chatRef = ref(db, `rooms/${roomId}/chat`);

/* ç©å®¶ */
let playerId = localStorage.getItem("playerId");
if (!playerId) {
  playerId = "p_" + Math.random().toString(36).substr(2,8);
  localStorage.setItem("playerId", playerId);
}

let playerName = localStorage.getItem("playerName"); // ğŸ”¥ ä¿®å¤ç‚¹
let owned = [];
let players = {};
let chatMessages = [];
let lastDrawnHex = null;

/* æµ·å…‹æ–¯ */
const hexList = [
  {name:"çº¢ä¸­å¤§ä¹é€",desc:"æ‘¸åˆ°çº¢ä¸­æ—¶å†æ‘¸ä¸¤å¼ "},
  {name:"ä¸æ‹˜ä¸€æ ¼",desc:"å¯ä»åºŸå¼ƒç‰Œä¸­æ‘¸ç‰Œ"},
  {name:"å¼€æ‘†",desc:"ä¸‰è½®æ— æ³•è¡ŒåŠ¨"},
  {name:"åæœŸä¸“å®¶",desc:"æœ€åé˜¶æ®µèƒ¡ç‰Œç¿»å€"},
  {name:"ç¦æ˜Ÿä¹‹å†•",desc:"å‘è´¢ä¸ºä¸‡èƒ½ç‰Œ"},
  {name:"å…‰æ˜å·å·",desc:"å‘ä¸€äººç´¢è¦æŒ‡å®šç‰Œ"}
];

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

/* åˆå§‹åŒ–å¡æ±  */
onValue(poolRef, snap => {
  if (!snap.val()) set(poolRef, shuffle([...hexList]));
});

/* ğŸ”¥ è‡ªåŠ¨æ¢å¤ç™»å½• */
async function autoJoinIfExists() {

  if (!playerName) return;

  const snap = await get(ref(db, `rooms/${roomId}/players/${playerId}`));

  if (snap.exists()) {
    enterGame();
  }
}

autoJoinIfExists();

/* åŠ å…¥ */
window.joinGame = async function() {

  const inputName = prompt("è¯·è¾“å…¥åå­—");
  if (!inputName) return;

  playerName = inputName.trim();
  localStorage.setItem("playerName", playerName); // ğŸ”¥ ä¿å­˜åå­—

  const playerRef = ref(db, `rooms/${roomId}/players/${playerId}`);

  await update(playerRef, {
    name: playerName,
    owned: []
  });

  onDisconnect(playerRef).remove();

  enterGame();
};

function enterGame() {
  document.getElementById("joinSection").style.display = "none";
  document.getElementById("gameSection").style.display = "block";
}

/* æŠ½å¡ï¼ˆç»å¯¹ç§æœ‰ï¼‰ */
window.drawHex = async function() {

  const result = await runTransaction(poolRef, pool => {

    if (!pool || pool.length === 0)
      pool = shuffle([...hexList]);

    const drawn = pool.shift();
    lastDrawnHex = drawn;
    return pool;
  });

  if (!result.committed || !lastDrawnHex) return;

  const newOwned = [...owned, lastDrawnHex];

  await update(ref(db, `rooms/${roomId}/players/${playerId}`), {
    owned: newOwned
  });

  alert("ä½ æŠ½åˆ°äº†ï¼š" + lastDrawnHex.name);
};

/* ä½¿ç”¨ */
window.useHex = function(index) {

  const hex = owned[index];

  const otherPlayers = Object.values(players)
    .filter(p => p.name !== playerName);

  let menu = "é€‰æ‹©ç›®æ ‡ï¼š\n1. å¯¹è‡ªå·±\n";
  otherPlayers.forEach((p,i)=>{
    menu += `${i+2}. å¯¹ ${p.name}\n`;
  });
  menu += `${otherPlayers.length+2}. å¯¹æ‰€æœ‰äºº`;

  const choice = prompt(menu);
  if (!choice) return;

  let target;

  if (choice == 1) {
    target = playerName;
  } else if (choice == otherPlayers.length + 2) {
    target = "æ‰€æœ‰äºº";
  } else {
    target = otherPlayers[choice-2]?.name;
  }

  owned.splice(index,1);
  update(ref(db, `rooms/${roomId}/players/${playerId}`), { owned });

  /* ğŸ”¥ å…¬å±åªå±•ç¤ºä½¿ç”¨è¡Œä¸º */
  if (target !== playerName) {
    push(chatRef, {
      text: `${playerName} å¯¹ ${target} ä½¿ç”¨äº†ã€${hex.name}ã€‘`,
      time: Date.now()
    });
  }
};

/* æ¸…ç©º */
window.clearRoom = async function() {

  if (!confirm("ç¡®å®šæ¸…ç©ºæˆ¿é—´ï¼Ÿ")) return;

  await remove(roomRef);

  localStorage.removeItem("playerName"); // ğŸ”¥ å¼ºåˆ¶é‡æ–°è¾“å…¥
  playerName = null;

  document.getElementById("gameSection").style.display = "none";
  document.getElementById("joinSection").style.display = "block";
};

/* ç›‘å¬ */
onValue(playersRef, snap=>{
  players = snap.val() || {};
  renderPlayers();
});

/* ğŸ”’ åªç›‘å¬è‡ªå·±çš„ owned */
onValue(ref(db, `rooms/${roomId}/players/${playerId}/owned`), snap=>{
  owned = snap.val() || [];
  renderOwned();
});

onValue(chatRef, snap=>{
  chatMessages = snap.val() ? Object.values(snap.val()) : [];
  renderChat();
});

/* æ¸²æŸ“ */
function renderPlayers(){
  document.getElementById("playerList").innerHTML =
    Object.values(players).map(p=>`<li>${p.name}</li>`).join("");
}

function renderOwned(){
  const container = document.getElementById("owned");
  container.innerHTML = "";
  owned.forEach((h,i)=>{
    const div = document.createElement("div");
    div.className="hex";
    div.innerHTML=`<strong>${h.name}</strong><br>${h.desc}`;
    div.onclick=()=>useHex(i);
    container.appendChild(div);
  });
}

function renderChat(){
  const chat=document.getElementById("chat");
  chat.innerHTML=chatMessages.map(m=>`<div>${m.text}</div>`).join("");
  chat.scrollTop=chat.scrollHeight;
}
</script>

<style>
body{font-family:system-ui;text-align:center;padding:15px;background:#f5f5f5}
button{padding:10px 20px;margin:8px;border-radius:8px;border:none;background:#ff9800;color:white}
.hex{background:#4caf50;color:white;padding:12px;border-radius:10px;margin:10px 0;cursor:pointer}
#chat{background:white;border:1px solid #ddd;height:200px;overflow-y:auto;padding:10px;margin:20px auto;max-width:600px;border-radius:10px;text-align:left}
</style>
</head>

<body>

<div id="joinSection">
<h1>ğŸ´ æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—</h1>
<button onclick="joinGame()">åŠ å…¥æ¸¸æˆ</button>
</div>

<div id="gameSection" style="display:none;">
<button onclick="drawHex()">æŠ½æµ·å…‹æ–¯</button>
<button onclick="clearRoom()">æ¸…ç©ºæˆ¿é—´</button>

<h3>åœ¨çº¿ç©å®¶</h3>
<ul id="playerList"></ul>

<h3>æˆ‘çš„æµ·å…‹æ–¯</h3>
<div id="owned"></div>

<h3>å…¬å±</h3>
<div id="chat"></div>
</div>

</body>
</html>
