<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—ï¼ˆè”æœºæˆ¿é—´ç‰ˆï¼‰</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { 
  getDatabase, 
  ref, 
  set, 
  onValue, 
  get, 
  push, 
  update,
  runTransaction,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

/* =============================
   ä½ çš„ Firebase é…ç½®ï¼ˆæœªä¿®æ”¹ï¼‰
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyAmqq64kRIAzTKdnveJqg25XTV19QMmQ1s",
  authDomain: "choujiang-88289.firebaseapp.com",
  databaseURL: "https://choujiang-88289-default-rtdb.firebaseio.com",
  projectId: "choujiang-88289",
  storageBucket: "choujiang-88289.firebasestorage.app",
  messagingSenderId: "423937514409",
  appId: "1:423937514409:web:c674a44070bfab9e5482b8",
  measurementId: "G-27T9NNLNL6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* =============================
   æˆ¿é—´ç³»ç»Ÿ
============================= */
let roomId = localStorage.getItem("roomId");
if (!roomId) {
  roomId = prompt("è¯·è¾“å…¥æˆ¿é—´å·ï¼ˆå¯è‡ªå®šä¹‰ï¼‰") || 
           "room_" + Math.random().toString(36).substr(2,6);
  localStorage.setItem("roomId", roomId);
}

const poolRef = ref(db, `rooms/${roomId}/pool`);
const playersRef = ref(db, `rooms/${roomId}/players`);
const chatRef = ref(db, `rooms/${roomId}/chat`);

/* =============================
   ç©å®¶ID
============================= */
let playerName = localStorage.getItem("playerName");
let playerId = localStorage.getItem("playerId");

if (!playerId) {
  playerId = "p_" + Math.random().toString(36).substr(2,8);
  localStorage.setItem("playerId", playerId);
}

let owned = [];
let players = {};
let chatMessages = [];
let lastDrawnHex = null;

/* =============================
   ä½ çš„å®Œæ•´æµ·å…‹æ–¯åˆ—è¡¨ï¼ˆåŸå°ä¸åŠ¨ï¼‰
============================= */
const hexList = [
  {name:"çº¢ä¸­å¤§ä¹é€",desc:"æ‘¸åˆ°çº¢ä¸­æ—¶ï¼Œç«‹åˆ»å†æ‘¸ä¸¤å¼ ï¼Œç„¶åæ‰”å‡ºä¸¤å¼ ç‰Œ"},
  {name:"ä¸æ‹˜ä¸€æ ¼",desc:"ä½ å¯ä»¥é€‰æ‹©ä¸åœ¨ç‰Œå †ï¼Œè€Œæ˜¯åœ¨åºŸå¼ƒç‰Œä¸­æ‘¸ä¸€å¼ ç‰Œ"},
  {name:"å¼€æ‘†",desc:"ä½ æ¥ä¸‹æ¥ä¸‰è½®æ— æ³•è¡ŒåŠ¨ï¼Œç¬¬å››è½®æ—¶å¯ä»¥æ‘¸å…­å¼ ç‰Œ"},
  {name:"åæœŸä¸“å®¶",desc:"å½“ç‰Œåªå‰©æœ€åä¸€æ’æ—¶ï¼Œä½ èƒ¡ç‰Œå€æ•°ç¿»å€"},
  {name:"æ½˜å¤šæ‹‰å¤‡æˆ˜å¸­",desc:"ä½ æœ‰ä¸€å¼ æ‰‹ç‰Œå¯ä»¥å½“åšåŒæ ·ç‚¹æ•°çš„å…¶ä»–ç‰Œ"},
  {name:"ç¦æ˜Ÿä¹‹å†•",desc:"ä½ å¯ä»¥æŠŠå‘è´¢å½“åšä¸‡èƒ½ç‰Œä½¿ç”¨"},
  {name:"å˜å½¢é‡ç»„å™¨",desc:"å¼€å±€ä½¿ç”¨ï¼Œæ‰”ä¸€ä¸ªéª°å­ï¼Œæ ¹æ®ç‚¹æ•°æ‘¸å‡ æ‰“å‡ "},
  {name:"æ¶é­”å¥‘çº¦",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½ åªèƒ½é€šè¿‡æ¸…ä¸€è‰²èƒ¡ç‰Œï¼Œæ¯å›åˆå¯ä»¥æ‘¸ä¸¤å¼ ç‰Œï¼Œæ¸…ä¸€è‰²ä¸ºç¿»å››ç•ª"},
  {name:"å…‰æ˜å·å·",desc:"å‘ä¸€ä¸ªäººç´¢è¦ä¸€å¼ æŒ‡å®šç‰Œï¼ˆéä¸‡èƒ½ç‰Œï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»–ä¸‹å›åˆæ— æ³•è¡ŒåŠ¨"},
  {name:"è¡Œå®¶é‡Œæ‰‹",desc:"å¼€å±€ä½¿ç”¨ï¼Œé€‰æ‹©ä¸€ä¸ªç©å®¶æŠ½å–ä»–çš„ä¸‰å¼ æ‰‹ç‰Œå¹¶è¿˜ç»™ä»–ä¸‰å¼ "},
  {name:"äº†è§£ä½ çš„æ•Œäºº",desc:"é€‰æ‹©ä¸€åç©å®¶æ˜ç‰Œè¡ŒåŠ¨"},
  {name:"å…ˆè‹¦åç”œ",desc:"å¦‚æœä½ å‡‘é½ä¸œè¥¿å—åŒ—é£å››å¼ ç‰Œï¼Œå¯ä»¥ä¸€å›åˆæ‰“æ‰è¿™å››å¼ ç‰Œï¼Œå¹¶ä¸”æ‘¸ä¸‰å¼ ç‰Œï¼Œæœ‰ä¸€å¼ å¯è§†ä¸ºä¸‡èƒ½ç‰Œ"},
  {name:"æ‹†å¸å™¨",desc:"ä½ å¯ä»¥è®©ä¸€ä¸ªç©å®¶çš„æµ·å…‹æ–¯æ— æ³•ç”Ÿæ•ˆ"},
  {name:"å—è›®å…¥ä¾µ",desc:"æœ¬å›åˆæ‰€æœ‰äººå¿…é¡»æ‰“å‡ºæ¡å­ï¼Œå¦åˆ™èƒ¡ç‰Œç•ªæ•°-2"},
  {name:"ä¸‡ç®­é½å‘",desc:"æœ¬å›åˆæ‰€æœ‰äººå¿…é¡»æ‰“å‡ºä¸‡å­ï¼Œå¦åˆ™èƒ¡ç‰Œç•ªæ•°-2"},
  {name:"å®å®éº»å°†",desc:"ä½ æ¯ç¢°ä¸€æ¬¡ç‰Œï¼Œèƒ¡ç‰Œç•ªæ•°+2"},
  {name:"æœ€åå‚¨å¤‡",desc:"å½“ä½ å³å°†æ­»äº¡æ—¶ï¼Œä½ å…ç–«æœ¬å›åˆçš„æ·˜æ±°"},
  {name:"æœ€ä½³å¥½å‹",desc:"å¦‚æœä½ å·²ç»å¬ç‰Œï¼Œæœ‰ä¸€å®¶èƒ¡ç‰Œæ—¶ä»–çš„ç‰Œä¸­æœ‰ä½ å¬çš„ç‰Œï¼Œåˆ™ä½ æ— éœ€ä»˜å‡º"},
  {name:"ä¼˜æŸ”å¯¡æ–­",desc:"æœ¬å›åˆæ— æ³•è¡ŒåŠ¨ï¼Œä¸‹ä¸ªå›åˆå·å–ä¸€ä¸ªäººçš„æµ·å…‹æ–¯"},
  {name:"é¥é¥é¢†å…ˆ",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½ æ— æ³•æ‘¸ç‰Œï¼Œè½¬è€Œä»å¼ƒç‰Œå †é‡Œé¢æ‘¸å–ä¸€å¼ "},
  {name:"è‹±é›„ç™»åœº",desc:"å½“ä¸€äººèƒ¡ç‰Œæ—¶ï¼Œä½ å¯ä»¥ç”¨ä¸€å¼ ç‰Œæ¢å–ä»–æ‰€æ‘¸åˆ°çš„é‚£å¼ ç‰Œæˆªèƒ¡"},
  {name:"åˆ©æ»šåˆ©",desc:"å½“ä½ è¿ç»­ä¸‰æŠŠæœªèƒ¡ç‰Œæ—¶ï¼Œä¸‹ä¸€æŠŠèƒ¡ç‰Œç¿»å€"},
  {name:"æ¸…æ™°å¤´è„‘",desc:"å¦‚æœä½ æœ¬å±€æ²¡æœ‰ç¢°ï¼Œæ èƒ¡äº†ï¼Œæœ¬å±€ç•ªæ•°+3"},
  {name:"å¥‹èµ·ç›´è¿½",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½äºåäº”ç‚¹ç­¹ç æ—¶ï¼Œæœ¬å±€æ‘¸äºŒæ‰“äºŒ"},
  {name:"å•†åº—æ•…éšœ",desc:"ä½ å¯ä»¥é€‰æ‹©ä¸€ç§ç‰Œï¼ˆæ¡é¥¼ä¸‡æ‚ï¼‰ï¼Œç›´åˆ°æ‘¸åˆ°è¯¥ç§ç±»ç‰Œä¸ºæ­¢"},
  {name:"èƒœåˆ©å®£å‘Š",desc:"å¦‚æœä½ åœ¨ç«çƒ­è¿èƒœçŠ¶æ€ï¼Œèƒ¡ç‰Œç•ªæ•°ä¹˜äºŒï¼Œç›´åˆ°å¤±è´¥ä¸ºæ­¢"},
  {name:"æ£±å½©å‘½è¿",desc:"ä½ ç«‹åˆ»æŠ½å–ä¸‰ä¸ªæµ·å…‹æ–¯ï¼Œä»ä¸­æŠ½å–ä¸€ä¸ª"},
  {name:"å†³æ–—",desc:"æŒ‡å®šä¸¤ä¸ªäººè½®æµå‡ºæŒ‡å®šç‰Œå‹"},
  {name:"é‡å¯ä»»åŠ¡",desc:"æ”¾å¼ƒè‡ªå·±çš„ç‰Œé‡æ–°æ‘¸å–"},
  {name:"å…‰æ˜æ°´é“¶",desc:"å…¶ä»–äººçš„æµ·å…‹æ–¯æ— æ³•å¯¹ä½ ç”Ÿæ•ˆ"},
  {name:"ä¼‘çœ é”»ç‚‰",desc:"ä¸‹å›åˆå¯ä»¥æŠ½ä¸¤ä¸ªæµ·å…‹æ–¯"},
  {name:"å†’é™©ä¸¾åŠ¨",desc:"æ˜ç‰Œè¡ŒåŠ¨ï¼Œè‹¥èƒ¡ç‰Œç•ªæ•°ä¹˜ä¸‰"},
  {name:"äº”è°·ä¸°ç™»",desc:"æ‘¸å››å¼ ç‰Œè½®æµé€‰"},
  {name:"æ½˜å¤šæ‹‰çš„ç›’å­",desc:"èƒ¡ç‰Œæ—¶æŠ½å–ä¸¤æ¬¡å†³å®šç•ªæ•°"},
  {name:"Dä¸ªç—›å¿«",desc:"æœ¬å›åˆæ‘¸ä¸‰æ‰“ä¸‰"},
  {name:"åˆ«å†é”™è¿‡",desc:"å¯ä»è‡ªå·±æ‰“å‡ºå»çš„ç‰Œä¸­æ‘¸ä¸€å¼ "},
  {name:"æŒ‘ä¸ªå¥½ä¼™è®¡",desc:"å¬ç‰Œæ—¶å¯åˆ¤å®šæ¢å–ç‰Œ"}
];

/* =============================
   åˆå§‹åŒ–å¡æ± 
============================= */
onValue(poolRef, (snap) => {
  let pool = snap.val();
  if (!pool || pool.length === 0) {
    set(poolRef, shuffle([...hexList]));
  }
});

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

/* =============================
   å¹¶å‘å®‰å…¨æŠ½å¡
============================= */
window.drawHex = async function() {

  const result = await runTransaction(poolRef, (pool) => {

    if (!pool || pool.length === 0) {
      pool = shuffle([...hexList]);
    }

    const drawn = pool.shift();
    lastDrawnHex = drawn;
    return pool;
  });

  if (!result.committed || !lastDrawnHex) return;

  const myOwned = [...owned, lastDrawnHex];

  await update(ref(db, `rooms/${roomId}/players/${playerId}`), {
    owned: myOwned
  });

  addChatMessage(`${playerName} æŠ½åˆ°äº† ã€${lastDrawnHex.name}ã€‘`);
};

/* =============================
   åŠ å…¥æ¸¸æˆ + è‡ªåŠ¨ä¸‹çº¿
============================= */
window.joinGame = function() {

  if (!playerName) {
    playerName = prompt("è¯·è¾“å…¥åå­—ï¼š");
    if (!playerName) return;
    localStorage.setItem("playerName", playerName);
  }

  const playerRef = ref(db, `rooms/${roomId}/players/${playerId}`);

  update(playerRef, {
    name: playerName,
    owned: []
  });

  onDisconnect(playerRef).remove();

  document.getElementById("joinSection").style.display = "none";
  document.getElementById("gameSection").style.display = "block";
};

/* =============================
   ç›‘å¬
============================= */
onValue(playersRef, (snap) => {
  players = snap.val() || {};
  renderPlayers();
});

onValue(ref(db, `rooms/${roomId}/players/${playerId}/owned`), (snap) => {
  owned = snap.val() || [];
  renderOwned();
});

onValue(chatRef, (snap) => {
  chatMessages = snap.val() ? Object.values(snap.val()) : [];
  renderChat();
});

/* =============================
   å…¶ä»–å‡½æ•°
============================= */
window.useHex = function(index) {
  const hex = owned[index];
  alert(`ä½ ä½¿ç”¨äº†ã€${hex.name}ã€‘`);
  owned.splice(index,1);
  update(ref(db, `rooms/${roomId}/players/${playerId}`), { owned });
  addChatMessage(`${playerName} ä½¿ç”¨äº† ã€${hex.name}ã€‘`);
};

function addChatMessage(text) {
  push(chatRef, { text, timestamp: Date.now() });
}

function renderPlayers() {
  const count = Object.keys(players).length;
  document.getElementById("playerCount").textContent = 
    `å½“å‰åœ¨çº¿ï¼š${count} äºº`;
  document.getElementById("playerList").innerHTML =
    Object.values(players)
      .map(p => `<li>${p.name}</li>`).join("");
}

function renderOwned() {
  const container = document.getElementById("owned");
  container.innerHTML = "";
  owned.forEach((h,i) => {
    const div = document.createElement("div");
    div.className = "hex";
    div.innerHTML = `<strong>${h.name}</strong>${h.desc}`;
    div.onclick = () => useHex(i);
    container.appendChild(div);
  });
}

function renderChat() {
  const chat = document.getElementById("chat");
  chat.innerHTML = chatMessages
    .map(m => `<div class="chat-msg">${m.text}</div>`).join("");
  chat.scrollTop = chat.scrollHeight;
}
</script>

<style>
body { margin:0; font-family:system-ui; background:#f5f5f5; text-align:center; padding:15px; }
button { padding:12px 24px; margin:8px; border-radius:8px; border:none; background:#ff9800; color:white; cursor:pointer; }
.hex { background:#4caf50; color:white; padding:12px; border-radius:10px; margin:10px 0; text-align:left; cursor:pointer; }
#chat { background:white; border:1px solid #ddd; height:200px; overflow-y:auto; padding:10px; margin:20px auto; max-width:600px; border-radius:10px; text-align:left;}
.chat-msg { margin:6px 0; padding:6px; background:#f0f0f0; border-radius:6px; }
</style>
</head>

<body>
<div id="joinSection">
  <h1>ğŸ´ æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—ï¼ˆæˆ¿é—´ç‰ˆï¼‰</h1>
  <button onclick="joinGame()">åŠ å…¥æ¸¸æˆ</button>
</div>

<div id="gameSection" style="display:none;">
  <p id="playerCount"></p>
  <ul id="playerList"></ul>
  <button onclick="drawHex()">æŠ½ä¸€ä¸ªæµ·å…‹æ–¯</button>
  <h3>æˆ‘çš„æµ·å…‹æ–¯</h3>
  <div id="owned"></div>
  <h3>å…¬å±</h3>
  <div id="chat"></div>
</div>
</body>
</html>
