<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—ï¼ˆè”æœºç‰ˆï¼‰</title>

<!-- Firebase Modular SDK CDN -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, get, push, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æ›¿æ¢æˆä½ è‡ªå·±çš„ Firebase é…ç½®ï¼ˆå¿…é¡»ï¼ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyAmqq64kRIAzTKdnveJqg25XTV19QMmQ1s",
    authDomain: "choujiang-88289.firebaseapp.com",
    databaseURL: "https://choujiang-88289-default-rtdb.firebaseio.com",
    projectId: "choujiang-88289",
    storageBucket: "choujiang-88289.firebasestorage.app",
    messagingSenderId: "423937514409",
    appId: "1:423937514409:web:c674a44070bfab9e5482b8",
    measurementId: "G-27T9NNLNL6"
  };
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // æµ·å…‹æ–¯åˆ—è¡¨
  const hexList = [
    {name:"çº¢ä¸­å¤§ä¹é€",desc:"æ‘¸åˆ°çº¢ä¸­æ—¶ï¼Œç«‹åˆ»å†æ‘¸ä¸¤å¼ ï¼Œç„¶åæ‰”å‡ºä¸¤å¼ ç‰Œ"},
    {name:"ä¸æ‹˜ä¸€æ ¼",desc:"ä½ å¯ä»¥é€‰æ‹©ä¸åœ¨ç‰Œå †ï¼Œè€Œæ˜¯åœ¨åºŸå¼ƒç‰Œä¸­æ‘¸ä¸€å¼ ç‰Œ"},
    {name:"å¼€æ‘†",desc:"ä½ æ¥ä¸‹æ¥ä¸‰è½®æ— æ³•è¡ŒåŠ¨ï¼Œç¬¬å››è½®æ—¶å¯ä»¥æ‘¸å…­å¼ ç‰Œ"},
    {name:"åæœŸä¸“å®¶",desc:"å½“ç‰Œåªå‰©æœ€åä¸€æ’æ—¶ï¼Œä½ èƒ¡ç‰Œå€æ•°ç¿»å€"},
    {name:"æ½˜å¤šæ‹‰å¤‡æˆ˜å¸­",desc:"ä½ æœ‰ä¸€å¼ æ‰‹ç‰Œå¯ä»¥å½“åšåŒæ ·ç‚¹æ•°çš„å…¶ä»–ç‰Œ"},
    {name:"ç¦æ˜Ÿä¹‹å†•",desc:"ä½ å¯ä»¥æŠŠå‘è´¢å½“åšä¸‡èƒ½ç‰Œä½¿ç”¨"},
    {name:"å˜å½¢é‡ç»„å™¨",desc:"å¼€å±€ä½¿ç”¨ï¼Œæ‰”ä¸€ä¸ªéª°å­ï¼Œæ ¹æ®ç‚¹æ•°æ‘¸å‡ æ‰“å‡ "},
    {name:"æ¶é­”å¥‘çº¦",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½ åªèƒ½é€šè¿‡æ¸…ä¸€è‰²èƒ¡ç‰Œï¼Œæ¯å›åˆå¯ä»¥æ‘¸ä¸¤å¼ ç‰Œï¼Œæ¸…ä¸€è‰²ä¸ºç¿»å››ç•ª"},
    {name:"å…‰æ˜å·å·",desc:"å‘ä¸€ä¸ªäººç´¢è¦ä¸€å¼ æŒ‡å®šç‰Œï¼ˆéä¸‡èƒ½ç‰Œï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»–ä¸‹å›åˆæ— æ³•è¡ŒåŠ¨"},
    {name:"è¡Œå®¶é‡Œæ‰‹",desc:"å¼€å±€ä½¿ç”¨ï¼Œé€‰æ‹©ä¸€ä¸ªç©å®¶æŠ½å–ä»–çš„ä¸‰å¼ æ‰‹ç‰Œå¹¶è¿˜ç»™ä»–ä¸‰å¼ "},
    {name:"äº†è§£ä½ çš„æ•Œäºº",desc:"é€‰æ‹©ä¸€åç©å®¶æ˜ç‰Œè¡ŒåŠ¨"},
    {name:"å…ˆè‹¦åç”œ",desc:"å¦‚æœä½ å‡‘é½ä¸œè¥¿å—åŒ—é£å››å¼ ç‰Œï¼Œå¯ä»¥ä¸€å›åˆæ‰“æ‰è¿™å››å¼ ç‰Œï¼Œå¹¶ä¸”æ‘¸ä¸‰å¼ ç‰Œï¼Œæœ‰ä¸€å¼ å¯è§†ä¸ºä¸‡èƒ½ç‰Œ"},
    {name:"æ‹†å¸å™¨",desc:"ä½ å¯ä»¥è®©ä¸€ä¸ªç©å®¶çš„æµ·å…‹æ–¯æ— æ³•ç”Ÿæ•ˆ"},
    {name:"å—è›®å…¥ä¾µ",desc:"æœ¬å›åˆæ‰€æœ‰äººå¿…é¡»æ‰“å‡ºæ¡å­ï¼Œå¦åˆ™èƒ¡ç‰Œç•ªæ•°-2"},
    {name:"ä¸‡ç®­é½å‘",desc:"æœ¬å›åˆæ‰€æœ‰äººå¿…é¡»æ‰“å‡ºä¸‡å­ï¼Œå¦åˆ™èƒ¡ç‰Œç•ªæ•°-2"},
    {name:"å®å®éº»å°†",desc:"ä½ æ¯ç¢°ä¸€æ¬¡ç‰Œï¼Œèƒ¡ç‰Œç•ªæ•°+2"},
    {name:"æœ€åå‚¨å¤‡",desc:"å½“ä½ å³å°†æ­»äº¡æ—¶ï¼Œä½ å…ç–«æœ¬å›åˆçš„æ·˜æ±°ï¼Œä¸‹ä¸€æ¬¡å¯¹å±€æ—¶ï¼Œæœ‰ä¸¤å¼ ç‰Œå¯ä»¥å½“åšä¸‡èƒ½ç‰Œä½¿ç”¨å¹¶ä¸”ç•ªæ•°ä¹˜2"},
    {name:"æœ€ä½³å¥½å‹",desc:"å¦‚æœä½ å·²ç»å¬ç‰Œï¼Œæœ‰ä¸€å®¶èƒ¡ç‰Œæ—¶ä»–çš„ç‰Œä¸­æœ‰ä½ å¬çš„ç‰Œï¼Œåˆ™ä½ æ— éœ€ä»˜å‡º"},
    {name:"ä¼˜æŸ”å¯¡æ–­",desc:"æœ¬å›åˆæ— æ³•è¡ŒåŠ¨ï¼Œä¸‹ä¸ªå›åˆå·å–ä¸€ä¸ªäººçš„æµ·å…‹æ–¯"},
    {name:"é¥é¥é¢†å…ˆ",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½ æ— æ³•æ‘¸ç‰Œï¼Œè½¬è€Œä»å¼ƒç‰Œå †é‡Œé¢æ‘¸å–ä¸€å¼ "},
    {name:"è‹±é›„ç™»åœº",desc:"å½“ä¸€äººèƒ¡ç‰Œæ—¶ï¼Œä½ å¯ä»¥ç”¨ä¸€å¼ ç‰Œæ¢å–ä»–æ‰€æ‘¸åˆ°çš„é‚£å¼ ç‰Œæˆªèƒ¡"},
    {name:"åˆ©æ»šåˆ©",desc:"å½“ä½ è¿ç»­ä¸‰æŠŠæœªèƒ¡ç‰Œæ—¶ï¼Œä¸‹ä¸€æŠŠèƒ¡ç‰Œç¿»å€"},
    {name:"æ¸…æ™°å¤´è„‘",desc:"å¦‚æœä½ æœ¬å±€æ²¡æœ‰ç¢°ï¼Œæ èƒ¡äº†ï¼Œæœ¬å±€ç•ªæ•°+3"},
    {name:"å¥‹èµ·ç›´è¿½",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½äºåäº”ç‚¹ç­¹ç æ—¶ï¼Œæœ¬å±€æ‘¸äºŒæ‰“äºŒ"},
    {name:"å•†åº—æ•…éšœ",desc:"ä½ å¯ä»¥é€‰æ‹©ä¸€ç§ç‰Œï¼ˆæ¡é¥¼ä¸‡æ‚ï¼‰ï¼Œç›´åˆ°æ‘¸åˆ°è¯¥ç§ç±»ç‰Œä¸ºæ­¢"},
    {name:"èƒœåˆ©å®£å‘Š",desc:"å¦‚æœä½ åœ¨ç«çƒ­è¿èƒœçŠ¶æ€ï¼Œèƒ¡ç‰Œç•ªæ•°ä¹˜äºŒï¼Œç›´åˆ°å¤±è´¥ä¸ºæ­¢"},
    {name:"æ£±å½©å‘½è¿",desc:"ä½ ç«‹åˆ»æŠ½å–ä¸‰ä¸ªæµ·å…‹æ–¯ï¼Œä»ä¸­æŠ½å–ä¸€ä¸ªï¼Œå…¶ä½™ä¸¤ä¸ªä½œåºŸ"},
    {name:"å†³æ–—",desc:"ä½ å¯ä»¥æŒ‡å®šä¸¤ä¸ªäººä¸¤è½®è½®æµå‡ºä½ æŒ‡å®šçš„ç‰Œå‹ï¼ˆæ¡é¥¼ä¸‡æ‚ï¼‰ï¼Œè‹¥æœ‰äººå‡ºä¸å‡ºæ¥åˆ™ä¸‹å›åˆæ— æ³•è¡ŒåŠ¨"},
    {name:"é‡å¯ä»»åŠ¡",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½ å¯ä»¥é€‰æ‹©æ”¾å¼ƒè‡ªå·±çš„ç‰Œè½¬è€Œé‡æ–°æ‘¸å–"},
    {name:"å…‰æ˜æ°´é“¶",desc:"ä½¿å…¶ä»–äººçš„æµ·å…‹æ–¯æ— æ³•å¯¹ä½ ç”Ÿæ•ˆ"},
    {name:"ä¼‘çœ é”»ç‚‰",desc:"ä½¿ç”¨è¯¥æµ·å…‹æ–¯ä¹‹åä¸‹å›åˆå¯ä»¥æŠ½å–ä¸¤ä¸ªæµ·å…‹æ–¯"},
    {name:"å†’é™©ä¸¾åŠ¨",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½ é€‰æ‹©æ˜ç‰Œè¡ŒåŠ¨ï¼Œè‹¥èƒ¡ç‰Œåˆ™ç•ªæ•°ä¹˜ä¸‰"},
    {name:"äº”è°·ä¸°ç™»",desc:"ç«‹åˆ»æ‘¸å–å››å¼ ç‰Œï¼Œä»è‡ªå·±å¼€å§‹è½®æµé€‰æ‹©ä¸€å¼ "},
    {name:"æ½˜å¤šæ‹‰çš„ç›’å­",desc:"ä½ èƒ¡ç‰Œæ—¶å¯ä»¥é€‰æ‹©æŠ½å–ä¸¤æ¬¡å†³å®šä½ çš„ç•ªæ•°"},
    {name:"Dä¸ªç—›å¿«",desc:"æœ¬å›åˆä½ å¯ä»¥æ‘¸ä¸‰æ‰“ä¸‰"},
    {name:"åˆ«å†é”™è¿‡",desc:"ä½ å¯ä»¥æ”¾å¼ƒæ‘¸ç‰Œé˜¶æ®µï¼Œè½¬è€Œä»è‡ªå·±æ‰“å‡ºå»çš„ç‰Œä¸­æ‘¸ä¸€å¼ "},
    {name:"æŒ‘ä¸ªå¥½ä¼™è®¡",desc:"è‹¥ä½ å·²ç»å¬ç‰Œï¼Œå…¶ä½™äººæ‰“å‡ºä¸€å¼ ä½ æ‰€å¬çš„ç‰Œï¼Œä½ å¯ä»¥è¿›è¡Œä¸€æ¬¡åˆ¤å®šï¼Œè‹¥ä¸‹å¼ ç‰Œä¸ºä½ æ‰€é¢„æµ‹çš„ç±»å‹ï¼ˆæ¡é¥¼ä¸‡æ‚ï¼‰ï¼Œåˆ™ä½ å¯ä»¥æ‹¿ä¸€å¼ ç‰Œæ¢å–ä½ æ‰€å¬çš„ç‰Œ"}
  ];

  let playerName = localStorage.getItem("playerName");
  let playerId = localStorage.getItem("playerId");
  if (!playerId) {
    playerId = "p_" + Math.random().toString(36).substr(2, 8);
    localStorage.setItem("playerId", playerId);
  }

  const poolRef = ref(db, 'hex/pool');
  const playersRef = ref(db, 'hex/players');
  const chatRef = ref(db, 'hex/chat');

  let owned = [];
  let players = {};
  let chatMessages = [];

  onValue(poolRef, (snap) => {
    let pool = snap.val();
    if (!pool || pool.length === 0) {
      pool = shuffle([...hexList]);
      set(poolRef, pool);
    }
  });

  onValue(playersRef, (snap) => {
    players = snap.val() || {};
    if (playerName && !players[playerId]) {
      update(ref(db, `hex/players/${playerId}`), {
        name: playerName,
        owned: []
      });
    }
    renderPlayers();
  });

  onValue(ref(db, `hex/players/${playerId}/owned`), (snap) => {
    owned = snap.val() || [];
    renderOwned();
  });

  onValue(chatRef, (snap) => {
    chatMessages = snap.val() ? Object.values(snap.val()) : [];
    renderChat();
  });

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function joinGame() {
    if (!playerName) {
      playerName = prompt("è¯·è¾“å…¥ä½ çš„åå­—ï¼š");
      if (!playerName || !playerName.trim()) {
        alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
        return joinGame();
      }
      playerName = playerName.trim();
      localStorage.setItem("playerName", playerName);
    }

    update(ref(db, `hex/players/${playerId}`), {
      name: playerName,
      owned: []
    });

    document.getElementById("joinSection").style.display = "none";
    document.getElementById("gameSection").style.display = "block";
  }

  function drawHex() {
    get(poolRef).then(snap => {
      let pool = snap.val() || shuffle([...hexList]);
      if (pool.length === 0) pool = shuffle([...hexList]);

      const drawn = pool.shift();
      set(poolRef, pool);

      const myOwned = [...owned, drawn];
      update(ref(db, `hex/players/${playerId}`), { owned: myOwned });

      addChatMessage(`${playerName} æŠ½åˆ°äº† ã€${drawn.name}ã€‘`);
    });
  }

  function useHex(index) {
    const hex = owned[index];
    const playerNames = Object.values(players).map(p => p.name).filter(n => n !== playerName);
    const options = ["å¯¹è‡ªå·±", ...playerNames, "å¯¹æ‰€æœ‰äºº"];

    let choice = prompt(`ä½¿ç”¨ ã€${hex.name}ã€‘\n\nç›®æ ‡é€‰é¡¹ï¼ˆè¾“å…¥å¯¹åº”æ•°å­—ï¼‰ï¼š\n1. å¯¹è‡ªå·±\n${playerNames.map((n,i) => `${i+2}. å¯¹ ${n}`).join('\n') || 'ï¼ˆæš‚æ— å…¶ä»–ç©å®¶ï¼‰'}\n${playerNames.length + 2}. å¯¹æ‰€æœ‰äºº\n\nè¯·è¾“å…¥æ•°å­—ï¼š`);

    if (!choice || isNaN(choice) || choice < 1 || choice > options.length) {
      alert("æ— æ•ˆé€‰æ‹©");
      return;
    }

    const target = options[choice - 1];
    let targetText = target === "å¯¹è‡ªå·±" ? playerName : target;

    alert(`ä½ å¯¹ ${targetText} ä½¿ç”¨äº† ã€${hex.name}ã€‘`);

    owned.splice(index, 1);
    update(ref(db, `hex/players/${playerId}`), { owned });

    addChatMessage(`${playerName} ä½¿ç”¨äº† ã€${hex.name}ã€‘ å¯¹ ${targetText}`);
  }

  function addChatMessage(text) {
    push(chatRef, {
      text,
      timestamp: Date.now(),
      sender: playerName
    });
  }

  function renderPlayers() {
    const count = Object.keys(players).length;
    document.getElementById("playerCount").textContent = `å½“å‰åœ¨çº¿ï¼š${count} äºº`;
    document.getElementById("playerList").innerHTML = Object.values(players).map(p => `<li>${p.name}</li>`).join("");
  }

  function renderOwned() {
    const container = document.getElementById("owned");
    container.innerHTML = "";
    owned.forEach((h, i) => {
      const div = document.createElement("div");
      div.className = "hex";
      div.innerHTML = `<strong>${h.name}</strong>${h.desc}`;
      div.onclick = () => useHex(i);
      container.appendChild(div);
    });
  }

  function renderChat() {
    const chat = document.getElementById("chat");
    chat.innerHTML = chatMessages.map(m => `<div class="chat-msg">${m.text}</div>`).join("");
    chat.scrollTop = chat.scrollHeight;
  }

  window.onload = () => {
    if (playerName) {
      document.getElementById("joinSection").style.display = "none";
      document.getElementById("gameSection").style.display = "block";
      joinGame();
    }
  };

  document.getElementById("joinBtn").onclick = joinGame;
</script>

<style>
body { margin:0; font-family:system-ui, sans-serif; background:#f5f5f5; text-align:center; padding:15px; }
h1 { margin:10px 0; font-size:1.6rem; }
button { padding:12px 24px; font-size:1rem; margin:8px; border-radius:8px; border:none; background:#ff9800; color:white; cursor:pointer; }
#resetBtn { background:#f44336; }
#owned { max-height:55vh; overflow-y:auto; margin:15px auto; max-width:600px; }
.hex { background:#4caf50; color:white; padding:12px 16px; border-radius:10px; margin:10px 0; text-align:left; cursor:pointer; }
.hex strong { display:block; font-size:1.1rem; margin-bottom:6px; }
#playerList { list-style:none; padding:0; margin:10px auto; max-width:400px; }
#playerList li { background:#e8e8e8; padding:8px; margin:6px 0; border-radius:6px; }
#chat { background:white; border:1px solid #ddd; height:220px; overflow-y:auto; text-align:left; padding:12px; margin:20px auto; max-width:600px; border-radius:10px; }
.chat-msg { margin:8px 0; padding:8px; background:#f0f0f0; border-radius:6px; }
#joinSection, #gameSection { margin:20px auto; max-width:600px; }
</style>
</head>
<body>

<div id="joinSection">
  <h1>ğŸ´ æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—ï¼ˆè”æœºï¼‰</h1>
  <p>è¯·è¾“å…¥åå­—åŠ å…¥æ¸¸æˆ</p>
  <button id="joinBtn">åŠ å…¥æ¸¸æˆ</button>
</div>

<div id="gameSection" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h1>æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—</h1>
    <button id="resetBtn" onclick="if(confirm('é‡ç½®å°†æ¸…ç©ºæ•°æ®ï¼Œç¡®å®šï¼Ÿ')) location.reload();">é‡ç½®</button>
  </div>

  <p id="playerCount">å½“å‰åœ¨çº¿ï¼š0 äºº</p>
  <ul id="playerList"></ul>

  <button id="drawBtn" onclick="drawHex()">æŠ½ä¸€ä¸ªæµ·å…‹æ–¯</button>

  <h3>æˆ‘çš„æµ·å…‹æ–¯ï¼ˆç‚¹å‡»ä½¿ç”¨ï¼‰</h3>
  <div id="owned"></div>

  <h3>å…¬å±</h3>
  <div id="chat"></div>
</div>

</body>
</html>
