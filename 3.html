<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è”æœºæŠ½å¥–ç³»ç»Ÿ - Modular SDK</title>
  <!-- Firebase Modular SDK CDN (v10.x æœ€æ–°ç¨³å®šç‰ˆ) -->
  <script type="module">
    // æ‰€æœ‰ä»£ç æ”¾è¿™é‡Œï¼Œå› ä¸º type="module" æ”¯æŒ import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, push, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js";  // å¯é€‰ï¼Œå¦‚æœä½ éœ€è¦åˆ†æ

    // ä½ çš„é…ç½®ï¼ˆç›´æ¥å¤åˆ¶ä½ è´´çš„ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyAmqq64kRIAzTKdnveJqg25XTV19QMmQ1s",
      authDomain: "choujiang-88289.firebaseapp.com",
      databaseURL: "https://choujiang-88289-default-rtdb.firebaseio.com",
      projectId: "choujiang-88289",
      storageBucket: "choujiang-88289.firebasestorage.app",
      messagingSenderId: "423937514409",
      appId: "1:423937514409:web:c674a44070bfab9e5482b8",
      measurementId: "G-27T9NNLNL6"
    };

    // åˆå§‹åŒ–
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    // const analytics = getAnalytics(app);  // å¯é€‰

    let roomId = "default-room";
    let myName = "";
    let isHost = false;

    // åŠ å…¥æŠ½å¥–
    window.join = function() {
      roomId = document.getElementById("roomId").value.trim() || "default-room";
      myName = document.getElementById("myName").value.trim();
      if (!myName) {
        alert("è¯·è¾“å…¥åå­—ï¼");
        return;
      }

      // å†™å…¥ç©å®¶æ•°æ®ï¼ˆç”¨ set è¦†ç›–åŒåï¼Œé¿å…é‡å¤ï¼‰
      set(ref(db, `rooms/${roomId}/players/${myName}`), {
        name: myName,
        joinedAt: Date.now()
      });

      // ç›‘å¬ç©å®¶åˆ—è¡¨å˜åŒ–
      onValue(ref(db, `rooms/${roomId}/players`), (snapshot) => {
        const list = document.getElementById("participants");
        list.innerHTML = "";
        const players = snapshot.val() || {};
        Object.values(players).forEach(p => {
          const li = document.createElement("li");
          li.textContent = p.name;
          list.appendChild(li);
        });

        // ç®€å•æˆ¿ä¸»é€»è¾‘ï¼šç¬¬ä¸€ä¸ªåŠ å…¥çš„äººæ˜¯æˆ¿ä¸»
        const playerKeys = Object.keys(players);
        if (playerKeys.length === 1 && playerKeys[0] === myName) {
          isHost = true;
          document.getElementById("startBtn").style.display = "inline-block";
        }
      });

      // ç›‘å¬ä¸­å¥–è€…
      onValue(ref(db, `rooms/${roomId}/winner`), (snapshot) => {
        const winner = snapshot.val();
        if (winner) {
          document.getElementById("winner").textContent = `ğŸ‰ å¤§å¥–å¾—ä¸»ï¼š${winner} ğŸ‰`;
          document.getElementById("status").textContent = "æŠ½å¥–ç»“æŸï¼";
        }
      });

      document.getElementById("status").textContent = "å·²åŠ å…¥ï¼ç­‰å¾…å¼€å§‹...";
    };

    // å¼€å§‹æŠ½å¥–ï¼ˆæˆ¿ä¸»ä¸“ç”¨ï¼‰
    window.startDraw = function() {
      if (!isHost) {
        alert("åªæœ‰æˆ¿ä¸»èƒ½å¼€å§‹æŠ½å¥–å“¦~");
        return;
      }

      get(ref(db, `rooms/${roomId}/players`)).then((snapshot) => {
        const players = snapshot.val() || {};
        const names = Object.keys(players);
        if (names.length < 1) {
          alert("æ²¡äººå‚åŠ å‘¢ï¼");
          return;
        }

        const winnerIndex = Math.floor(Math.random() * names.length);
        const winnerName = names[winnerIndex];

        set(ref(db, `rooms/${roomId}/winner`), winnerName);
      });
    };

    // é‡ç½®
    window.reset = function() {
      if (confirm("ç¡®å®šé‡ç½®ï¼Ÿæ‰€æœ‰æ•°æ®æ¸…ç©ºï¼")) {
        remove(ref(db, `rooms/${roomId}`));
        location.reload();
      }
    };
  </script>

  <style>
    body{font-family:system-ui,sans-serif;background:#111;color:#fff;text-align:center;padding:20px;}
    h1{color:#ffeb3b;}
    #participants{list-style:none;padding:0;}
    #participants li{background:#333;margin:8px auto;padding:10px;border-radius:8px;max-width:300px;}
    #status{font-size:1.4em;margin:20px;color:#4caf50;}
    button{font-size:1.2em;padding:12px 24px;margin:10px;background:#2196f3;color:white;border:none;border-radius:8px;cursor:pointer;}
    button:hover{background:#1976d2;}
    #winner{font-size:3em;color:#ff5722;margin:40px 0;font-weight:bold;animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.1);}100%{transform:scale(1);}}
    input{padding:10px;font-size:1.1em;margin:8px;width:220px;}
  </style>
</head>
<body>

<h1>è”æœºæŠ½å¥–ç³»ç»Ÿ</h1>

<div>
  <input id="roomId" placeholder="æˆ¿é—´åï¼ˆæ¯”å¦‚ï¼š2026å¹´ä¼šï¼‰" value="default-room" />
  <input id="myName" placeholder="ä½ çš„åå­—" />
  <button onclick="join()">åŠ å…¥æŠ½å¥–</button>
</div>

<h3>å‚ä¸è€…ï¼ˆå®æ—¶ï¼‰</h3>
<ul id="participants"></ul>

<div id="status">ç­‰å¾…ä¸­...</div>

<button id="startBtn" onclick="startDraw()" style="display:none;">å¼€å§‹æŠ½å¥–ï¼</button>
<button onclick="reset()">é‡ç½®æŠ½å¥–</button>

<div id="winner"></div>

</body>
</html>