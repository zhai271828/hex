<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—ï¼ˆå¢å¼ºæˆ¿é—´ç‰ˆï¼‰</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { 
  getDatabase, 
  ref, 
  set, 
  onValue, 
  push, 
  update,
  runTransaction,
  onDisconnect,
  remove
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

/* =============================
   ä½ çš„ Firebase é…ç½®ï¼ˆæœªæ”¹ï¼‰
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyAmqq64kRIAzTKdnveJqg25XTV19QMmQ1s",
  authDomain: "choujiang-88289.firebaseapp.com",
  databaseURL: "https://choujiang-88289-default-rtdb.firebaseio.com",
  projectId: "choujiang-88289",
  storageBucket: "choujiang-88289.firebasestorage.app",
  messagingSenderId: "423937514409",
  appId: "1:423937514409:web:c674a44070bfab9e5482b8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* =============================
   æˆ¿é—´ç³»ç»Ÿ
============================= */
let roomId = localStorage.getItem("roomId");
if (!roomId) {
  roomId = prompt("è¯·è¾“å…¥æˆ¿é—´å·") || "1";
  localStorage.setItem("roomId", roomId);
}

const roomRef = ref(db, `rooms/${roomId}`);
const poolRef = ref(db, `rooms/${roomId}/pool`);
const playersRef = ref(db, `rooms/${roomId}/players`);
const chatRef = ref(db, `rooms/${roomId}/chat`);

/* =============================
   ç©å®¶
============================= */
let playerName = localStorage.getItem("playerName");
let playerId = localStorage.getItem("playerId");

if (!playerId) {
  playerId = "p_" + Math.random().toString(36).substr(2,8);
  localStorage.setItem("playerId", playerId);
}

let owned = [];
let players = {};
let chatMessages = [];
let lastDrawnHex = null;

/* =============================
   æµ·å…‹æ–¯åˆ—è¡¨ï¼ˆå®Œæ•´ä¿ç•™ï¼‰
============================= */
const hexList = [
  {name:"çº¢ä¸­å¤§ä¹é€",desc:"æ‘¸åˆ°çº¢ä¸­æ—¶ï¼Œç«‹åˆ»å†æ‘¸ä¸¤å¼ ï¼Œç„¶åæ‰”å‡ºä¸¤å¼ ç‰Œ"},
  {name:"ä¸æ‹˜ä¸€æ ¼",desc:"ä½ å¯ä»¥é€‰æ‹©ä¸åœ¨ç‰Œå †ï¼Œè€Œæ˜¯åœ¨åºŸå¼ƒç‰Œä¸­æ‘¸ä¸€å¼ ç‰Œ"},
  {name:"å¼€æ‘†",desc:"ä½ æ¥ä¸‹æ¥ä¸‰è½®æ— æ³•è¡ŒåŠ¨ï¼Œç¬¬å››è½®æ—¶å¯ä»¥æ‘¸å…­å¼ ç‰Œ"},
  {name:"åæœŸä¸“å®¶",desc:"å½“ç‰Œåªå‰©æœ€åä¸€æ’æ—¶ï¼Œä½ èƒ¡ç‰Œå€æ•°ç¿»å€"},
  {name:"æ½˜å¤šæ‹‰å¤‡æˆ˜å¸­",desc:"ä½ æœ‰ä¸€å¼ æ‰‹ç‰Œå¯ä»¥å½“åšåŒæ ·ç‚¹æ•°çš„å…¶ä»–ç‰Œ"},
  {name:"ç¦æ˜Ÿä¹‹å†•",desc:"ä½ å¯ä»¥æŠŠå‘è´¢å½“åšä¸‡èƒ½ç‰Œä½¿ç”¨"},
  {name:"å˜å½¢é‡ç»„å™¨",desc:"å¼€å±€ä½¿ç”¨ï¼Œæ‰”ä¸€ä¸ªéª°å­ï¼Œæ ¹æ®ç‚¹æ•°æ‘¸å‡ æ‰“å‡ "},
  {name:"æ¶é­”å¥‘çº¦",desc:"å¼€å±€ä½¿ç”¨ï¼Œä½ åªèƒ½é€šè¿‡æ¸…ä¸€è‰²èƒ¡ç‰Œ"},
  {name:"å…‰æ˜å·å·",desc:"å‘ä¸€ä¸ªäººç´¢è¦ä¸€å¼ æŒ‡å®šç‰Œ"},
  {name:"è¡Œå®¶é‡Œæ‰‹",desc:"æŠ½å–ä¸€ä¸ªç©å®¶ä¸‰å¼ æ‰‹ç‰Œ"}
];

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

/* =============================
   åˆå§‹åŒ–å¡æ± 
============================= */
onValue(poolRef, (snap) => {
  let pool = snap.val();
  if (!pool || pool.length === 0) {
    set(poolRef, shuffle([...hexList]));
  }
});

/* =============================
   åŠ å…¥æ¸¸æˆ
============================= */
window.joinGame = function() {

  if (!playerName) {
    playerName = prompt("è¯·è¾“å…¥åå­—");
    if (!playerName) return;
    localStorage.setItem("playerName", playerName);
  }

  const playerRef = ref(db, `rooms/${roomId}/players/${playerId}`);

  update(playerRef, {
    name: playerName,
    owned: []
  });

  onDisconnect(playerRef).remove();

  document.getElementById("joinSection").style.display = "none";
  document.getElementById("gameSection").style.display = "block";
};

/* =============================
   æŠ½å¡ï¼ˆäº‹åŠ¡å®‰å…¨ï¼‰
============================= */
window.drawHex = async function() {

  const result = await runTransaction(poolRef, (pool) => {

    if (!pool || pool.length === 0) {
      pool = shuffle([...hexList]);
    }

    const drawn = pool.shift();
    lastDrawnHex = drawn;
    return pool;
  });

  if (!result.committed || !lastDrawnHex) return;

  const myOwned = [...owned, lastDrawnHex];

  await update(ref(db, `rooms/${roomId}/players/${playerId}`), {
    owned: myOwned
  });

  addChatMessage(`${playerName} æŠ½åˆ°äº† ã€${lastDrawnHex.name}ã€‘`);
};

/* =============================
   ä½¿ç”¨æµ·å…‹æ–¯ï¼ˆå¸¦ç›®æ ‡é€‰æ‹©ï¼‰
============================= */
window.useHex = function(index) {

  const hex = owned[index];

  const otherPlayers = Object.values(players)
    .filter(p => p.name !== playerName)
    .map(p => p.name);

  let menu = "é€‰æ‹©ç›®æ ‡ï¼š\n1. å¯¹è‡ªå·±\n";
  otherPlayers.forEach((name,i) => {
    menu += `${i+2}. å¯¹ ${name}\n`;
  });
  menu += `${otherPlayers.length+2}. å¯¹æ‰€æœ‰äºº`;

  const choice = prompt(menu);

  if (!choice) return;

  let target = "";

  if (choice == 1) {
    target = playerName;
  } else if (choice == otherPlayers.length + 2) {
    target = "æ‰€æœ‰äºº";
  } else {
    target = otherPlayers[choice - 2];
  }

  owned.splice(index,1);
  update(ref(db, `rooms/${roomId}/players/${playerId}`), { owned });

  addChatMessage(`${playerName} å¯¹ ${target} ä½¿ç”¨äº† ã€${hex.name}ã€‘`);
};

/* =============================
   æ¸…ç©ºæˆ¿é—´
============================= */
window.clearRoom = function() {
  if (!confirm("ç¡®å®šæ¸…ç©ºæ•´ä¸ªæˆ¿é—´ï¼Ÿ")) return;

  remove(roomRef);
  alert("æˆ¿é—´å·²æ¸…ç©ºï¼");
};

/* =============================
   ç›‘å¬
============================= */
onValue(playersRef, (snap) => {
  players = snap.val() || {};
  renderPlayers();
});

onValue(ref(db, `rooms/${roomId}/players/${playerId}/owned`), (snap) => {
  owned = snap.val() || [];
  renderOwned();
});

onValue(chatRef, (snap) => {
  chatMessages = snap.val() ? Object.values(snap.val()) : [];
  renderChat();
});

/* =============================
   æ¸²æŸ“
============================= */
function addChatMessage(text) {
  push(chatRef, { text, timestamp: Date.now() });
}

function renderPlayers() {
  document.getElementById("playerList").innerHTML =
    Object.values(players)
      .map(p => `<li>${p.name}</li>`).join("");
}

function renderOwned() {
  const container = document.getElementById("owned");
  container.innerHTML = "";
  owned.forEach((h,i) => {
    const div = document.createElement("div");
    div.className = "hex";
    div.innerHTML = `<strong>${h.name}</strong>${h.desc}`;
    div.onclick = () => useHex(i);
    container.appendChild(div);
  });
}

function renderChat() {
  const chat = document.getElementById("chat");
  chat.innerHTML = chatMessages
    .map(m => `<div class="chat-msg">${m.text}</div>`).join("");
  chat.scrollTop = chat.scrollHeight;
}

</script>

<style>
body { margin:0; font-family:system-ui; background:#f5f5f5; text-align:center; padding:15px; }
button { padding:10px 20px; margin:8px; border-radius:8px; border:none; background:#ff9800; color:white; cursor:pointer; }
.hex { background:#4caf50; color:white; padding:12px; border-radius:10px; margin:10px 0; text-align:left; cursor:pointer; }
#chat { background:white; border:1px solid #ddd; height:200px; overflow-y:auto; padding:10px; margin:20px auto; max-width:600px; border-radius:10px; text-align:left;}
.chat-msg { margin:6px 0; padding:6px; background:#f0f0f0; border-radius:6px; }
</style>
</head>

<body>
<div id="joinSection">
  <h1>ğŸ´ æµ·å…‹æ–¯éº»å°†å¤§ä¹±æ–—</h1>
  <button onclick="joinGame()">åŠ å…¥æ¸¸æˆ</button>
</div>

<div id="gameSection" style="display:none;">
  <button onclick="drawHex()">æŠ½ä¸€ä¸ªæµ·å…‹æ–¯</button>
  <button onclick="clearRoom()">æ¸…ç©ºæˆ¿é—´</button>

  <h3>åœ¨çº¿ç©å®¶</h3>
  <ul id="playerList"></ul>

  <h3>æˆ‘çš„æµ·å…‹æ–¯</h3>
  <div id="owned"></div>

  <h3>å…¬å±</h3>
  <div id="chat"></div>
</div>
</body>
</html>
